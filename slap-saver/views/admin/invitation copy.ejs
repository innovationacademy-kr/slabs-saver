<%- contentFor('navbar') %>
<link rel="stylesheet" href="/stylesheets/style.css">
<nav class="navbar navbar-expand-md navbar-dark bg-success mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">SLAB-SAVER</a>
    <ul class="navbar-nav me-auto mb-2 mb-md-0">
      <li class="nav-item">
        <a class="nav-link" aria-current="page" href="/author/_admin">홈</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/author/_admin/invitation">초대관리</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" href="#">기사 관리</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" href="#">기자 관리</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" href="#">유저 관리</a>
      </li>
    </ul>
    <a class="btn btn-primary" href="/author/logout">로그아웃</a>
  </div>
</nav>

<%- contentFor('body') %>
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
  초대하기
</button>
<div class="modal fade modal-dialog-centered" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-10" aria-labelledby="staticBackdropLabel" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">초대하기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form  class="needs-validation">
          <div class="modal-email">
            <label for="email" class="col-sm-2 text-center">이메일</label>
            <input type="email" autocapitalize="off" class="invite-email" id="email" required>
          </div>
          <div class="modal-name">
            <label for="name" class="col-sm-2 text-center">이름</label>
            <input class="invite-name" id="name"  required>
          </div>
          <div class="modal-code">
            <label for="position" class="col-sm-2 text-center">직급</label>    
            <select name="position" id="position" required>
              <option value="1" selected>편집장</option>
              <option value="2">데스크</option>
              <option value="3">일반기자</option>
            </select>
          </div>
          <div class="modal-code">
            <label for="category" class="col-sm-2 text-center">분야</label>    
            <select name="category" id="category" required disabled>
              <option value="1" selected>전체</option>
              <option value="2">정책</option>
              <option value="3">경제</option>
              <option value="4">사회</option>
              <option value="5">국제</option>
              <option value="6">문화</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary mt-3 text-center" id="invite">초대하기</button>
        </form>
      </div>
    </div>
  </div>
</div>

<section class="admin-table content">
  <div class="admin-table__category">
    <table class="table table-hover" name="table">
      <thead class="standby-user-header">
        <tr class="standby-user-header__row">
          <th scope="col">NO</th>
          <th scope="col">이메일</th>
          <th scope="col">이름</th>
          <th scope="col">진행 상황</th>
          <th scope="col">직급</th>
          <th scope="col">분야</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody class="standby-user-body">
        <% standByUsers.map((standByUser)=> { %>
        <!-- <form> -->
          <tr scope="row">
            <td><%= standByUser.id %></td>
            <td> <%= standByUser.email %></td>
            <td><%= standByUser.name %></td>
            <td>
              <% if (standByUser.intState > 2) { %>
                <div>
                  <progress class="declined" value=<%= standByUser.intState %> max="2"></progress>
                </div>
              <% } else { %>
                <div>
                  <progress value=<%= standByUser.intState %> max="2"></progress>
                </div>
              <% } %>
              <%= standByUser.state %>
            </td>
            <% if (standByUser.intState == 0) { %>
            <td>
              <select name="select_position" id="select_position">
                <option value="1" selected>편집장</option>
                <option value="2">데스크</option>
                <option value="3">일반기자</option>
              </select>
            </td>
              <td>
                <select name="select_category" id="select_category" required disabled>
                  <option value="1" selected>전체</option>
                  <option value="2">정책</option>
                  <option value="3">경제</option>
                  <option value="4">사회</option>
                  <option value="5">국제</option>
                  <option value="6">문화</option>
                </select>
              </td>

            <td>
              <button class="btn btn-success" id="approved" name="approved">승인</button>
            </td>
            <td>
              <button class="btn btn-danger" id="declined" name="declined">거절</button>
            </td>
            </td>
            <% } else { %>
            <!-- <td>
              <select name="select_position" id="select_position" disabled></select>
            </td>
            <td>
              <select name="select_category" id="select_category" required disabled></select>
            </td>
            <td>
              <button type="hidden" disabled class="btn btn-success" id="approved" name="approved">승인</button>
            </td>
            <td>
              <button type="hidden" disabled class="btn btn-danger" id="declined" name="declined">거절</button>
            </td>
            </td> -->
            <% }  %>
            <input type="hidden" value=<%= standByUser.email %> id="standByUser_email">
            <input type="hidden" value=<%= standByUser.name %> id="standByUser_name">
          </tr>
        <!-- </form> -->
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<!-- <style>
  .admin-table select:disabled, .admin-table button:disabled {
    visibility: hidden;
  }
</style> -->

<script>
  const selects = Array.from(document.querySelectorAll('#select_position'));
  const categories = Array.from(document.querySelectorAll('#select_category')); // 배열
  const emails = Array.from(document.querySelectorAll('#standByUser_email'));
  const approved_list = Array.from(document.querySelectorAll('#approved'));
  const declined_list = Array.from(document.querySelectorAll('#declined')); // 배열

  console.log(emails);

  document.querySelector('#position').addEventListener('change', (e) => {
  const { target: {value}} = e;
  // const value = e.target.value;
  const category =  document.querySelector('#category');
  if (e.target.value === '1') {
    //document.querySelector('#category option:first-child').disabled = false;
    category.value = '1';
    category.disabled = true;
  } else {
    document.querySelector('#category option:first-child').disabled = true;
    category.value = '2';
    category.disabled = false;
  }
})
  selects.map((el, index) => {
    el.addEventListener('change', (e) => {
    const { target: {value}} = e;
    // const value = e.target.value;
    const category =  categories[index];
    if (e.target.value === '1') {
      category.value = '1';
      category.disabled = true;
    } else {
      document.querySelector('#select_category option:first-child').disabled = true;
      category.value = '2';
      category.disabled = false;
    }
  })
  })
  approved_list.map((el, index)=>{
    const approved = approved_list[index];
    el.addEventListener('click', (e)=>{
        axios({
        method: "POST",
        url: '/author/_admin/decision',
        data: {
          "approved": 1,
          "select_position": selects[index].value,
          "select_category": categories[index].value,
          "email": emails[index].value,
        }
      }).then((res) => {
        console.log(emails[index].value);
        location.reload();
      }).catch(error => {
        alert(error.response.data.message);
      }); 
    })
  })

  declined_list.map((el, index)=>{
    const declined = declined_list[index];
    el.addEventListener('click', (e)=>{
        axios({
        method: "POST",
        url: '/author/_admin/decision',
        data: {
          "declined": 1,
          "email": emails[index].value,
        }
      }).then((res) => {
        location.reload();
        console.log(res);
      }).catch(error => {
        alert(error.response.data.message);
      }); 
    })
  })

  document.getElementById("invite").onclick = function invite() { 
    let email = document.getElementById("email");
    let name = document.getElementById('name')
    let position = document.getElementById("position");
    let category = document.getElementById("category");
    position = position.selectedIndex;
    category = category.selectedIndex;
      axios({
        method: "POST",
        url: '/author/_admin/invitation',
        data: {
          "email": email.value,
          "name": name.value,
          "position": position.selectedIndex,
          "category": category.selectedIndex
        }
      }).then((res) => {
        alert('메일을 전송했습니다');
        console.log(res);
        // location.href="/author/login";
      }).catch(error => {
        alert(error.response.data.message);
      }); 
  }
</script>
<script defer src="/vendors/axios/axios.min.js"></script>
<script src="/javascripts/adminNavbar.js"></script>

<%- contentFor('footer') %>
<%- include('../partials/footer.ejs') %>
